<!DOCTYPE html>
<html>
  <head>
    <title>Story Weaver</title>
    <link rel="stylesheet" href="index.css" />
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^0.8.0",
          "marked": "https://esm.sh/marked@^15.0.8"
        }
      }
    </script>
  </head>
  <body>
    <!-- Sidebar / Library -->
    <aside id="library-sidebar">
      <div class="sidebar-header">
        <h2>Your Stories</h2>
        <button id="close-sidebar-btn" class="icon-btn">&times;</button>
      </div>
      <button id="new-story-btn">
        <span>+ New Story</span>
      </button>
      <div id="story-list">
        <!-- Story items will be injected here -->
      </div>
    </aside>
    <div id="sidebar-overlay"></div>

    <header>
      <div class="header-left">
        <button id="menu-button" class="icon-btn" title="Open Library">
          <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1>Story Weaver</h1>
      </div>
      <div class="controls">
        <button id="settings-button" title="Configure Providers">Settings</button>
        <button id="help-button" title="Help & Troubleshooting">Help</button>
        <button id="save-button" title="Save to LocalStorage">Save</button>
        <button id="export-button" title="Export JSON">Export</button>
        <button id="import-button" title="Import JSON">Import</button>
        <input type="file" id="import-file" accept=".json" style="display: none;" />
      </div>
    </header>
    <main id="conversation-container">
        <div id="welcome-message">
            <h2>Welcome to Story Weaver</h2>
            <p>Start a new story by typing below, or select a story from the library.</p>
        </div>
    </main>
    <footer>
      <form id="prompt-form">
        <input
          type="text"
          id="prompt-input"
          placeholder="Weave a new story..."
          autocomplete="off"
        />
        <button type="submit" id="submit-button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
          <span>Generate</span>
        </button>
      </form>
    </footer>

    <!-- Settings Modal -->
    <dialog id="settings-dialog">
      <form method="dialog" id="settings-form">
        <div class="settings-header">
          <h2>Settings</h2>
          <button type="button" id="close-settings-btn" class="icon-btn">&times;</button>
        </div>
        
        <div class="tabs">
          <button type="button" class="tab-btn active" data-tab="chat-settings">Chat / Story</button>
          <button type="button" class="tab-btn" data-tab="image-settings">Images</button>
        </div>

        <div class="tab-content active" id="chat-settings">
          <div class="form-group">
            <label for="chat-provider">Provider</label>
            <select id="chat-provider">
              <option value="google">Google GenAI (Default)</option>
              <option value="custom">Custom Endpoint</option>
            </select>
          </div>
          
          <div class="form-group" id="chat-model-group">
            <label for="chat-model-select">Model Preset</label>
            <select id="chat-model-select">
              <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image (Free • Text & Image)</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash (Free • Text Only)</option>
              <option value="gemini-2.0-flash-lite-preview-02-05">Gemini 2.0 Flash Lite (Fast • Text Only)</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro (Paid • High Quality Text)</option>
            </select>
          </div>

          <div class="form-group hidden" id="chat-custom-model-group">
            <label for="chat-custom-model">Model Name</label>
            <input type="text" id="chat-custom-model" placeholder="e.g. gemini-1.5-flash" />
          </div>
          
          <div class="form-group">
            <label for="chat-writing-style">Writing Style</label>
            <select id="chat-writing-style">
              <option value="standard">Standard (Default)</option>
              <option value="descriptive">Descriptive & Detailed</option>
              <option value="concise">Concise & Direct</option>
              <option value="humorous">Humorous & Witty</option>
              <option value="dark">Dark & Gritty</option>
              <option value="poetic">Poetic & Lyrical</option>
              <option value="simple">Simple (for kids)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="chat-output-length">Response Length (Per Turn)</label>
            <select id="chat-output-length">
              <option value="short">Short (~100 words)</option>
              <option value="medium">Medium (~300 words)</option>
              <option value="long">Long (~600 words)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="chat-api-key">API Key <small>(Leave empty to use env default)</small></label>
            <input type="password" id="chat-api-key" placeholder="sk-..." />
          </div>
        </div>

        <div class="tab-content" id="image-settings">
          <p class="info-text">Configure image generation behavior.</p>
           <div class="form-group">
            <label for="image-provider">Provider</label>
            <select id="image-provider">
              <option value="google">Google GenAI</option>
            </select>
          </div>
          <div class="form-group">
            <label for="image-model-select">Model Preset</label>
            <select id="image-model-select">
              <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image (Standard)</option>
              <option value="gemini-3-pro-image-preview">Gemini 3 Pro Image (High Quality)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="image-aspect-ratio">Aspect Ratio</label>
            <select id="image-aspect-ratio">
              <option value="1:1">1:1 (Square)</option>
              <option value="16:9">16:9 (Landscape)</option>
              <option value="9:16">9:16 (Portrait)</option>
              <option value="4:3">4:3 (Standard)</option>
              <option value="3:4">3:4 (Portrait Standard)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="image-style">Style Preset</label>
            <select id="image-style">
              <option value="none">None (Default)</option>
              <option value="photorealistic">Photorealistic</option>
              <option value="anime">Anime / Manga</option>
              <option value="digital-art">Digital Art</option>
              <option value="painterly">Painterly / Oil Painting</option>
              <option value="watercolor">Watercolor</option>
              <option value="cyberpunk">Cyberpunk / Neon</option>
              <option value="sketch">Pencil Sketch</option>
              <option value="3d-render">3D Render</option>
            </select>
          </div>

          <div class="form-group">
            <label for="image-negative-prompt">Negative Prompt <small>(What to avoid)</small></label>
            <textarea id="image-negative-prompt" rows="2" placeholder="e.g. text, watermark, blurry, distorted hands"></textarea>
          </div>

           <div class="form-group">
            <label for="image-api-key">API Key <small>(Leave empty to use Chat key)</small></label>
            <input type="password" id="image-api-key" placeholder="sk-..." />
          </div>
        </div>

        <div class="dialog-actions">
          <button type="button" id="cancel-settings">Cancel</button>
          <button type="submit" id="save-settings">Save Changes</button>
        </div>
      </form>
    </dialog>

    <!-- Help Modal -->
    <dialog id="help-dialog">
      <div class="settings-header">
        <h2>Help & Support</h2>
        <button type="button" id="close-help-btn" class="icon-btn">&times;</button>
      </div>
      <div class="help-content">
        <h3>Quick Start</h3>
        <p>Type a prompt in the input box below and hit Enter or click Generate. The AI will weave a story for you, occasionally generating images to match the narrative.</p>
        
        <h3>Library</h3>
        <p>Access the library by clicking the menu icon (☰) in the top left. You can create new stories, switch between existing ones, and delete old stories.</p>

        <h3>Troubleshooting: Blank Responses</h3>
        <p>If you see a blank bubble:</p>
        <ul>
          <li><strong>Text Rendering:</strong> We have updated the renderer. If it persists, try refreshing the page.</li>
          <li><strong>Check Console:</strong> Press F12 or right-click > Inspect > Console. Look for "Debug Chunk" messages.</li>
          <li><strong>Model Selection:</strong> Some models (like Gemini 2.5 Flash Lite) might be unstable or text-only. Try switching to "Gemini 2.5 Flash" in Settings > Chat.</li>
        </ul>

        <h3>Settings Guide</h3>
        <ul>
          <li><strong>Chat/Story:</strong> Change the writing style (e.g., "Humorous", "Poetic") and the length of the response.</li>
          <li><strong>Images:</strong> Customize how images look. Use "Negative Prompt" to remove unwanted elements like "blurry" or "text".</li>
        </ul>
      </div>
      <div class="dialog-actions">
        <button type="button" id="close-help-action">Close</button>
      </div>
    </dialog>

    <script type="module" src="index.tsx"></script>
  </body>
</html>
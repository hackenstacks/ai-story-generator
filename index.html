<!DOCTYPE html>
<html>
  <head>
    <title>Story Weaver</title>
    <link rel="stylesheet" href="index.css" />
    <!-- Preload Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Courier+Prime&family=Dancing+Script:wght@400;700&family=Merriweather:wght@300;400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^0.8.0",
          "marked": "https://esm.sh/marked@^15.0.8"
        }
      }
    </script>
  </head>
  <body>
    <!-- Background Music Player -->
    <audio id="bg-music-player" loop hidden></audio>

    <!-- Header / Top Bar -->
    <header id="app-header">
        <button id="main-menu-toggle" class="icon-btn" title="Open Project Menu">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div id="mode-switcher">
            <button class="mode-btn" data-mode="editor" title="Write Script">üìù Editor</button>
            <button class="mode-btn active" data-mode="studio" title="Interactive Studio">üé® Studio</button>
            <button class="mode-btn" data-mode="player" title="Play Story">‚ñ∂Ô∏è Play</button>
        </div>
        <div id="mini-control-deck">
            <button id="mini-play-pause" title="Play/Pause Background">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="mini-narrator-toggle" title="Toggle Narrator">
                <span class="icon">üîá</span>
            </button>
            <button id="mini-expand" title="Open Media Center">
                <span class="icon">üéöÔ∏è</span>
            </button>
        </div>
    </header>

    <!-- Main Media Center (Slide Down) -->
    <div id="main-media-center">
        <div class="mmc-header">
            <h3>Media Control Center</h3>
            <div class="mmc-actions">
                <button id="mmc-cancel-btn">Cancel</button>
                <button id="mmc-ok-btn">OK</button>
            </div>
        </div>
        <div class="mmc-body">
            <!-- Audio Controls -->
            <div class="mmc-section">
                <h4>Audio Playback</h4>
                <div class="control-grid">
                    <div class="control-item">
                        <label>Ambience Volume</label>
                        <input type="range" id="mmc-bg-volume" min="0" max="1" step="0.05">
                    </div>
                    <div class="control-item">
                        <label>Narrator Volume</label>
                        <input type="range" id="mmc-narrator-volume" min="0" max="1" step="0.05">
                    </div>
                    <div class="control-item">
                        <label>Speed</label>
                        <select id="mmc-speed">
                            <option value="0.5">0.5x</option>
                            <option value="1.0" selected>1.0x</option>
                            <option value="1.25">1.2x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>
                </div>
                <div class="mmc-buttons">
                    <button id="mmc-play-pause">Play/Pause Ambience</button>
                    <button id="mmc-narrator-toggle">Enable Narration</button>
                    <button id="mmc-stop-all" class="danger-btn">Stop All Audio</button>
                </div>
            </div>

            <!-- Generation Tools -->
            <div class="mmc-section">
                <h4>AI Generation Tools</h4>
                <div class="mmc-buttons">
                    <button id="mmc-generate-ambience" title="Generate based on story context">
                        <span class="magic-wand">‚ú®</span> Auto Ambience
                    </button>
                    <button id="mmc-open-mixer" title="Select clips and mix">
                        <span class="icon">üéõÔ∏è</span> Sound Mixer
                    </button>
                     <button id="mmc-generate-video" title="Generate Video using Veo (Paid Key Required)">
                        <span class="icon">üé•</span> Generate Video (Veo)
                    </button>
                </div>
            </div>

            <!-- Configurations -->
            <div class="mmc-section">
                <h4>Media Configuration</h4>
                <div class="control-grid">
                    <div class="control-item">
                        <label>Narrator Voice</label>
                        <select id="mmc-tts-voice">
                          <option value="Puck">Puck</option>
                          <option value="Charon">Charon</option>
                          <option value="Kore">Kore</option>
                          <option value="Fenrir">Fenrir</option>
                          <option value="Zephyr">Zephyr</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>Image Aspect Ratio</label>
                        <select id="mmc-image-ratio">
                          <option value="1:1">1:1 (Square)</option>
                          <option value="16:9">16:9 (Landscape)</option>
                          <option value="9:16">9:16 (Portrait)</option>
                          <option value="4:3">4:3 (Standard)</option>
                          <option value="3:4">3:4 (Portrait Standard)</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>Image Style</label>
                        <select id="mmc-image-style">
                          <option value="none">None</option>
                          <option value="photorealistic">Photorealistic</option>
                          <option value="anime">Anime</option>
                          <option value="painterly">Painterly</option>
                          <option value="cyberpunk">Cyberpunk</option>
                          <option value="8bit">8-Bit / Pixel Art</option>
                          <option value="pixar">3D Animation (Pixar Style)</option>
                          <option value="fantasy">High Fantasy</option>
                          <option value="watercolor">Watercolor</option>
                          <option value="noir">Film Noir</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Navigation Menu (Vertical Sidebar) -->
    <nav id="main-menu">
      <div class="nav-header">
        <h2>Project Menu</h2>
        <button id="close-menu-btn" class="icon-btn">&times;</button>
      </div>
      
      <div class="nav-items">
        <button id="library-toggle-btn">
             <span class="icon">üìÇ</span> Projects / Library
        </button>
        <div class="separator"></div>
        <button id="settings-button">
            <span class="icon">‚öôÔ∏è</span> Settings
        </button>
        <button id="save-button">
            <span class="icon">üíæ</span> Save Project
        </button>
        <button id="export-button">
            <span class="icon">üì¶</span> System Backup
        </button>
        <button id="import-button">
            <span class="icon">‚¨ÜÔ∏è</span> Import System
        </button>
        <div class="separator"></div>
        <button id="help-button">
            <span class="icon">‚ùì</span> Help
        </button>
      </div>
      <input type="file" id="import-file" accept=".json" style="display: none;" />
    </nav>

    <!-- Library Sidebar (Secondary Sidebar) -->
    <aside id="library-sidebar">
      <div class="sidebar-header">
        <h2>Project Space</h2>
        <button id="close-sidebar-btn" class="icon-btn">&times;</button>
      </div>
      
      <div class="library-tabs">
          <button class="lib-tab active" data-target="story-list-container">Stories</button>
          <button class="lib-tab" data-target="assets-list-container">Assets</button>
      </div>

      <div id="story-list-container" class="lib-content active">
          <button id="new-story-btn">
            <span>+ New Story Project</span>
          </button>
          <div id="story-list">
            <!-- Story items will be injected here -->
          </div>
      </div>

      <div id="assets-list-container" class="lib-content">
          <div class="assets-actions">
              <label for="doc-upload" class="upload-btn secondary">
                  <span>üìÑ Import Doc</span>
                  <input type="file" id="doc-upload" accept=".txt,.md,.json" style="display: none;">
              </label>
              <label for="asset-upload" class="upload-btn primary">
                  <span>üì∑ Import Media</span>
                  <input type="file" id="asset-upload" accept="image/*,audio/*,video/*" style="display: none;">
              </label>
          </div>
          <p id="assets-filter-label" style="padding: 0 1rem; font-size: 0.8rem; color: #888; display:none;">Current Project Assets:</p>
          <div id="assets-list">
              <!-- Asset items will be injected here -->
          </div>
      </div>
    </aside>
    
    <div id="sidebar-overlay"></div>

    <!-- MAIN APP VIEWS -->
    
    <!-- 1. STUDIO MODE (Conversational) -->
    <main id="conversation-container" class="app-view active">
        <div id="welcome-message">
            <h2>Story Weaver Studio</h2>
            <p>Start a new story interactively or switch to <strong>Editor Mode</strong> to write a script.</p>
        </div>
    </main>

    <!-- 2. EDITOR MODE (Scripting) -->
    <div id="script-editor-container" class="app-view">
        <div class="editor-toolbar">
            <span class="editor-info">Use tags: <code>[VIDEO: prompt]</code> <code>[IMAGE: prompt]</code></span>
            <button id="compile-script-btn" class="tool-btn primary">
                <span>‚öôÔ∏è Compile to Story</span>
            </button>
        </div>
        <textarea id="script-textarea" placeholder="Title: The Dragon's Keep

[SCENE: A dark cave illuminated by glowing mushrooms.]

The dragon Rubios slept soundly on a pile of gold...

[IMAGE: A sleeping red dragon on gold piles, cinematic lighting]

Suddenly, a knight entered...

[VIDEO: A knight in shining armor drawing a sword, sparks flying]"></textarea>
    </div>

    <!-- 3. PLAYER MODE (Playback) -->
    <div id="player-container" class="app-view">
        <button id="exit-player-btn" class="icon-btn fixed-top-right">&times;</button>
        <div id="player-stage">
            <!-- Dynamic Content Here -->
        </div>
        <div class="player-controls">
            <button id="player-prev">‚Üê</button>
            <button id="player-next">‚Üí</button>
        </div>
    </div>

    <!-- Footer (Only for Studio) -->
    <footer id="studio-footer">
      <form id="prompt-form">
        <button type="button" id="footer-media-btn" title="Open Media Controls">
            <span class="icon">üéöÔ∏è</span>
        </button>
        <input
          type="text"
          id="prompt-input"
          placeholder="Weave a new story..."
          autocomplete="off"
        />
        <button type="submit" id="submit-button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
          <span>Generate</span>
        </button>
      </form>
    </footer>

    <!-- Asset Action Dialog -->
    <dialog id="asset-action-dialog">
        <form method="dialog">
            <div class="settings-header">
                <h2>Asset Options</h2>
                <button type="button" id="close-aad-btn" class="icon-btn">&times;</button>
            </div>
            <div class="dialog-content" style="text-align: center; padding: 2rem;">
                <div id="aad-preview-container" style="margin-bottom: 1.5rem;">
                    <!-- Preview Image/Video injected here -->
                </div>
                <p id="aad-name" style="margin-bottom: 1.5rem; color: #bbb;"></p>
                <div class="dialog-actions-vertical">
                    <button type="button" id="aad-insert-btn" class="action-btn-lg">Insert into Story</button>
                    <button type="button" id="aad-theme-btn" class="action-btn-lg">Set as Theme/Background</button>
                    <button type="button" id="aad-delete-btn" class="action-btn-lg danger">Delete Asset</button>
                </div>
            </div>
        </form>
    </dialog>

    <!-- Sound Generation Dialog (Mixer) -->
    <dialog id="sound-gen-dialog">
        <form method="dialog">
            <div class="settings-header">
                <h2>Custom Sound Mixer</h2>
                <button type="button" id="close-sound-gen-btn" class="icon-btn">&times;</button>
            </div>
            <div class="dialog-content">
                <p class="info-text">Select audio assets to mix/transform, and provide a prompt to guide the AI.</p>
                
                <div class="form-group">
                    <label>Select Audio Sources (Optional)</label>
                    <div id="audio-asset-selection-list">
                        <div class="empty-state">No audio assets in library.</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sound-gen-prompt">Guidance Prompt</label>
                    <textarea id="sound-gen-prompt" rows="3" placeholder="e.g. 'Mix these sounds into a spooky forest ambience with wind howling'"></textarea>
                </div>
            </div>
            <div class="dialog-actions">
                <button type="button" id="cancel-sound-gen-btn">Cancel</button>
                <button type="submit" id="confirm-sound-gen-btn">Generate Sound</button>
            </div>
        </form>
    </dialog>

    <!-- Video Generation Dialog -->
    <dialog id="video-gen-dialog">
        <form method="dialog">
            <div class="settings-header">
                <h2>Generate Video (Veo)</h2>
                <button type="button" id="close-video-gen-btn" class="icon-btn">&times;</button>
            </div>
            <div class="dialog-content">
                <p class="info-text">Create a short video using Google Veo. <br><strong>Note:</strong> This requires a paid API key and takes a minute to generate.</p>
                
                <div class="form-group">
                    <label for="video-gen-prompt">Video Prompt</label>
                    <textarea id="video-gen-prompt" rows="3" placeholder="e.g. A cyberpunk city with neon rain falling in slow motion..."></textarea>
                </div>
            </div>
            <div class="dialog-actions">
                <button type="button" id="cancel-video-gen-btn">Cancel</button>
                <button type="submit" id="confirm-video-gen-btn">Generate Video</button>
            </div>
        </form>
    </dialog>

    <!-- Regenerate Modal -->
    <dialog id="regenerate-dialog">
        <form method="dialog">
            <div class="settings-header">
                <h2>Regenerate Content</h2>
                <button type="button" id="close-regen-btn" class="icon-btn">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <div class="form-group">
                    <label for="regen-prompt">Steering Prompt (Optional)</label>
                    <input type="text" id="regen-prompt" placeholder="e.g. 'Make it more dramatic', 'Use blue colors'..." />
                    <small>Leave empty to let the AI decide the variation.</small>
                </div>
            </div>
            <div class="dialog-actions">
                <button type="button" id="cancel-regen-btn">Cancel</button>
                <button type="submit" id="confirm-regen-btn">Regenerate</button>
            </div>
        </form>
    </dialog>

    <!-- Settings Modal -->
    <dialog id="settings-dialog">
      <form method="dialog" id="settings-form">
        <div class="settings-header">
          <h2>Global Settings</h2>
          <button type="button" id="close-settings-btn" class="icon-btn">&times;</button>
        </div>
        
        <div class="tabs">
          <button type="button" class="tab-btn active" data-tab="chat-settings">Chat / Story</button>
          <button type="button" class="tab-btn" data-tab="theme-settings">Theme</button>
        </div>

        <div class="tab-content active" id="chat-settings">
          <div class="form-group">
            <label for="chat-provider">Provider</label>
            <select id="chat-provider">
              <option value="google">Google GenAI (Default)</option>
              <option value="custom">Custom Endpoint</option>
            </select>
          </div>
          
          <div class="form-group" id="chat-model-group">
            <label for="chat-model-select">Model Preset</label>
            <select id="chat-model-select">
              <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image (Free ‚Ä¢ Text & Image)</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash (Free ‚Ä¢ Text Only)</option>
              <option value="gemini-2.0-flash-lite-preview-02-05">Gemini 2.0 Flash Lite (Fast ‚Ä¢ Text Only)</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro (Paid ‚Ä¢ High Quality Text)</option>
            </select>
          </div>

          <div class="form-group hidden" id="chat-custom-model-group">
            <label for="chat-custom-model">Model Name</label>
            <input type="text" id="chat-custom-model" placeholder="e.g. gemini-1.5-flash" />
          </div>
          
          <div class="form-group">
            <label for="chat-api-key">API Key <small>(Leave empty to use env default)</small></label>
            <input type="password" id="chat-api-key" placeholder="sk-..." />
          </div>
        </div>

        <div class="tab-content" id="theme-settings">
          <div class="form-group">
            <label for="story-font">Story Font</label>
            <select id="story-font">
                <option value="">Auto-detected (Default)</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Courier Prime', monospace">Courier Prime</option>
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="'Cinzel', serif">Cinzel</option>
            </select>
          </div>
          <div class="form-group">
             <label>Custom Border Image</label>
             <input type="file" id="border-upload" accept="image/*" />
             <button type="button" id="clear-border-btn" style="margin-top:0.5rem; font-size: 0.8rem; padding: 0.4rem;">Reset</button>
          </div>
        </div>

        <div class="dialog-actions">
          <button type="button" id="cancel-settings">Cancel</button>
          <button type="submit" id="save-settings">Save Changes</button>
        </div>
      </form>
    </dialog>

    <!-- Help Modal -->
    <dialog id="help-dialog">
      <div class="settings-header">
        <h2>‚ú® Story Weaver Manual</h2>
        <button type="button" id="close-help-btn" class="icon-btn">&times;</button>
      </div>
      <div class="help-content">
        <h3>üßô‚Äç‚ôÇÔ∏è Welcome to Story Weaver</h3>
        <p>You have entered a <strong>military-grade</strong>, secure, offline-first storytelling interface.</p>
        
        <h3>üìù Modes</h3>
        <ul>
            <li><strong>Editor:</strong> Write your story script manually. Use tags like <code>[VIDEO: prompt]</code> or <code>[IMAGE: prompt]</code> to auto-generate media when you click "Compile".</li>
            <li><strong>Studio:</strong> The classic interactive chat interface where you build the story turn by turn.</li>
            <li><strong>Player:</strong> A polished, read-only view to experience your final story.</li>
        </ul>

        <h3>üìú Parchment Layout</h3>
        <p>Experience stories in a split-view parchment template. Text flows on a scroll-like paper to the side, while images and videos take center stage.</p>

        <h3>üé• Video Generation (Veo)</h3>
        <p>Use the <strong>Video</strong> button in the Media Center to generate short clips using Google Veo. You can also trigger this via script using the <code>[VIDEO: ...]</code> tag.</p>

        <h3>üì¶ System Backup</h3>
        <p>Use the <strong>System Backup</strong> button in the Menu to export a complete package of all your stories, assets, and settings.</p>
      </div>
      <div class="dialog-actions">
        <button type="button" id="close-help-action">Close</button>
      </div>
    </dialog>

    <script type="module" src="index.tsx"></script>
  </body>
</html>